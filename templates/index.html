<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Road Maintenance Optimizer - Genetic Algorithm</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v=12) }}">
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸ›£ï¸ Road Maintenance Optimizer</h1>
    <p>Genetic Algorithm untuk Optimasi Pemeliharaan Jalan - Himalayan Region</p>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button type="button" class="tab-button active" onclick="showTab('input')">ğŸ“š Data Jalan</button>
    <button type="button" class="tab-button" onclick="showTab('parameters')">âš™ï¸ Parameter Algoritma</button>
    {% if result %}
    <button type="button" class="tab-button" onclick="showTab('results')">ğŸ† Hasil Optimasi</button>
    {% endif %}
  </div>

  <form id="ga-form" method="post" action="/run">

    <!-- TAB 1: INPUT DATA -->
    <div id="tab-input" class="tab-content active">

      <!-- DATA JURNAL INFO CARD -->
      <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);">
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
          <div style="font-size: 4em;">ğŸ”ï¸</div>
          <div>
            <h2 style="margin: 0; color: white; font-size: 1.8em; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
              Data Studi Kasus Jurnal
            </h2>
            <p style="margin: 10px 0 0 0; font-size: 1.1em; opacity: 0.95;">
              <em>Nautiyal & Sharma (2022) - Himalayan Region</em>
            </p>
          </div>
        </div>
        
        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
          <h3 style="color: white; margin-top: 0; font-size: 1.3em;">ğŸ“Š Ringkasan Dataset</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
              <div style="font-size: 0.9em; opacity: 0.9;">ğŸ›£ï¸ Total Jalan</div>
              <div style="font-size: 2em; font-weight: 700; margin-top: 5px;">{{ roads|length }}</div>
              <div style="font-size: 0.85em; opacity: 0.85; margin-top: 5px;">Kandidat perbaikan</div>
            </div>
            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
              <div style="font-size: 0.9em; opacity: 0.9;">ğŸ”§ Teknik Maintenance</div>
              <div style="font-size: 2em; font-weight: 700; margin-top: 5px;">6</div>
              <div style="font-size: 0.85em; opacity: 0.85; margin-top: 5px;">OG, MS, RE, RM, SS, CF</div>
            </div>
            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
              <div style="font-size: 0.9em; opacity: 0.9;">ğŸ’° Total Budget</div>
              <div style="font-size: 2em; font-weight: 700; margin-top: 5px;">â‚¹{{ "{:,.0f}".format(total_budget) }}</div>
              <div style="font-size: 0.85em; opacity: 0.85; margin-top: 5px;">100% scenario</div>
            </div>
          </div>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
          <p style="margin: 0; font-size: 1.05em; line-height: 1.6;">
            âœ… Dataset dari jurnal low-volume rural roads<br>
            âœ… GA akan memilih jalan mana yang diperbaiki dalam budget<br>
            âœ… Optimasi: maksimalkan peningkatan PCR (Pavement Condition Rating) ğŸ“ˆ
          </p>
        </div>
      </div>

      <!-- TABEL ROADS -->
      <div class="card">
        <h2>ğŸ›£ï¸ Data Jalan - Kandidat Perbaikan</h2>
        <p style="margin-bottom: 20px; color: #666;">
          <strong>PCR (Pavement Condition Rating)</strong> menggunakan skala 0-3 dimana nilai lebih tinggi = kondisi lebih baik.
        </p>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #667eea; color: white;">
                <th style="padding: 12px; text-align: left;">Road ID</th>
                <th style="padding: 12px; text-align: center;">Technique</th>
                <th style="padding: 12px; text-align: center;">Present PCR</th>
                <th style="padding: 12px; text-align: center;">New PCR</th>
                <th style="padding: 12px; text-align: center;">Improvement</th>
                <th style="padding: 12px; text-align: right;">Cost (â‚¹)</th>
              </tr>
            </thead>
            <tbody>
              {% for road in roads %}
              <tr>
                <td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: 600;">{{ road.id }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">
                  <span style="background: #764ba2; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 500;">
                    {{ road.technique }}
                  </span>
                </td>
                <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">{{ "%.2f"|format(road.present_pcr) }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">{{ "%.2f"|format(road.new_pcr) }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">
                  {% set delta = road.new_pcr - road.present_pcr %}
                  <span style="color: {% if delta > 0 %}#22c55e{% else %}#999{% endif %}; font-weight: 600;">
                    {% if delta > 0 %}+{% endif %}{{ "%.2f"|format(delta) }}
                  </span>
                </td>
                <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">â‚¹{{ "{:,.0f}".format(road.cost) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- TABEL TEKNIK -->
      <div class="card">
        <h2>ğŸ”§ Penjelasan Teknik Maintenance</h2>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #764ba2; color: white;">
                <th style="padding: 12px; text-align: center;">Code</th>
                <th style="padding: 12px; text-align: left;">Technique</th>
                <th style="padding: 12px; text-align: left;">Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-weight: 600;">OG</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: 600;">Overlay</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">Penambahan lapisan aspal baru di atas permukaan existing</td>
              </tr>
              <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-weight: 600;">MS</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: 600;">Micro Surfacing</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">Treatment permukaan tipis untuk seal dan protect</td>
              </tr>
              <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-weight: 600;">RE</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: 600;">Rehabilitation</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">Perbaikan struktural menyeluruh untuk jalan rusak parah</td>
              </tr>
              <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-weight: 600;">RM</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: 600;">Routine Maintenance</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">Pemeliharaan rutin untuk jalan kondisi baik</td>
              </tr>
              <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-weight: 600;">SS</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: 600;">Surface Sealing</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">Seal coat untuk mencegah water infiltration</td>
              </tr>
              <tr>
                <td style="padding: 12px; text-align: center; font-weight: 600;">CF</td>
                <td style="padding: 12px; font-weight: 600;">Crack Filling</td>
                <td style="padding: 12px;">Pengisian retak untuk mencegah kerusakan lebih lanjut</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div style="margin-top: 15px; padding: 15px; background: #f0f7ff; border-left: 4px solid #4a6cf7; border-radius: 4px;">
          <p style="margin: 0; color: #333;">
            <strong>ğŸ’¡ Note:</strong> GA akan memilih subset jalan yang akan diperbaiki untuk memaksimalkan total peningkatan PCR dalam batasan budget yang tersedia.
          </p>
        </div>
      </div>

    </div> <!-- END TAB INPUT -->

    <!-- TAB 2: PARAMETERS -->
    <div id="tab-parameters" class="tab-content">
      <div class="card">
        <h2>âš™ï¸ Parameter Algoritma Genetika</h2>
        <p style="color: #666; margin-bottom: 25px;">
          ğŸ’¡ <strong>Nilai default sudah optimal!</strong> Ubah hanya jika Anda ingin bereksperimen dengan hasil yang berbeda.
        </p>

        <div class="form-grid">
          <div class="form-group">
            <label>
              ğŸ’° Budget Ratio
              <span class="param-hint">Persentase dari total budget yang tersedia</span>
            </label>
            <input type="number" name="budget_ratio" value="{{ params.budget_ratio if params else '1.0' }}" min="0.1" max="1.0" step="0.1">
            <small style="color: #888; display: block; margin-top: 5px;">
              ğŸ“Œ Optimal: 1.0 (100%) | Rentang: 0.1-1.0 | Total budget: â‚¹{{ "{:,.0f}".format(total_budget) if total_budget else '869,613' }}
            </small>
          </div>

          <div class="form-group">
            <label>
              ğŸ‘¥ Ukuran Populasi
              <span class="param-hint">Jumlah solusi kandidat per generasi</span>
            </label>
            <input type="number" name="population_size" value="{{ params.population_size if params else '50' }}" min="20" max="200" step="10">
            <small style="color: #888; display: block; margin-top: 5px;">
              ğŸ“Œ Optimal: 50 | Rentang: 20-200 | Lebih besar = hasil lebih baik tapi lebih lambat
            </small>
          </div>

          <div class="form-group">
            <label>
              ğŸ”„ Jumlah Generasi
              <span class="param-hint">Iterasi evolusi algoritma</span>
            </label>
            <input type="number" name="generations" value="{{ params.generations if params else '200' }}" min="20" max="500" step="10">
            <small style="color: #888; display: block; margin-top: 5px;">
              ğŸ“Œ Optimal: 200 | Rentang: 20-500 | Lebih banyak = konvergensi lebih baik tapi lebih lambat
            </small>
          </div>

          <div class="form-group">
            <label>
              ğŸ§¬ Crossover Rate
              <span class="param-hint">Probabilitas perkawinan silang (0-1)</span>
            </label>
            <input type="number" name="crossover_rate" value="{{ params.crossover_rate if params else '0.8' }}" step="0.05" min="0.5" max="1.0">
            <small style="color: #888; display: block; margin-top: 5px;">
              ğŸ“Œ Optimal: 0.8 | Rentang: 0.5-1.0 | Tinggi = eksplorasi kombinasi lebih agresif
            </small>
          </div>

          <div class="form-group">
            <label>
              ğŸ² Mutation Rate
              <span class="param-hint">Probabilitas mutasi gen (0-1)</span>
            </label>
            <input type="number" name="mutation_rate" value="{{ params.mutation_rate if params else '0.02' }}" step="0.01" min="0.01" max="0.1">
            <small style="color: #888; display: block; margin-top: 5px;">
              ğŸ“Œ Optimal: 0.02 | Rentang: 0.01-0.1 | Tinggi = variasi lebih besar, hindari local optimum
            </small>
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; border-left: 4px solid #4a6cf7;">
              <strong style="color: #333;">ğŸ’¡ Tips Optimasi:</strong>
              <ul style="margin: 10px 0 0 20px; color: #666;">
                <li><strong>Hasil terbaik:</strong> Pop=50, Gen=200, Cross=0.8, Mut=0.02 (â±ï¸ ~3 detik)</li>
                <li><strong>Cepat:</strong> Pop=30, Gen=100 (â±ï¸ ~1 detik, hasil cukup baik)</li>
                <li><strong>Maksimal:</strong> Pop=100, Gen=500 (â±ï¸ ~10 detik, hasil optimal)</li>
                <li><strong>Budget rendah:</strong> Naikkan mutation rate ke 0.05 untuk eksplorasi lebih luas</li>
              </ul>
            </div>
          </div>
        </div>

        <button type="submit" id="runButton" style="margin-top: 20px;">ğŸš€ Jalankan Optimasi GA</button>
      </div>
    </div>

    <!-- TAB 3: RESULTS -->
    {% if result %}
    <div id="tab-results" class="tab-content">

      <!-- SUMMARY -->
      <div class="summary-card">
        <div class="summary-header-line">
          <div class="summary-icon">ğŸ“Š</div>
          <div class="summary-title">Ringkasan Hasil Optimasi</div>
        </div>

        <div class="summary-items">
          <div class="summary-item">
            <div class="summary-item-label">Total PCR Improvement</div>
            <div class="summary-item-value">+{{ "%.2f"|format(result.total_delta_pcr) }}</div>
          </div>

          <div class="summary-item">
            <div class="summary-item-label">Present Avg PCR</div>
            <div class="summary-item-value">{{ "%.2f"|format(result.present_avg_pcr) }}</div>
          </div>

          <div class="summary-item">
            <div class="summary-item-label">New Avg PCR</div>
            <div class="summary-item-value">{{ "%.2f"|format(result.new_avg_pcr) }}</div>
          </div>

          <div class="summary-item">
            <div class="summary-item-label">Total Biaya</div>
            <div class="summary-item-value">â‚¹{{ "{:,.0f}".format(result.total_cost) }}</div>
          </div>

          <div class="summary-item">
            <div class="summary-item-label">Budget Limit</div>
            <div class="summary-item-value">â‚¹{{ "{:,.0f}".format(result.budget_limit) }}</div>
          </div>

          <div class="summary-item">
            <div class="summary-item-label">Budget Used</div>
            <div class="summary-item-value">
              {% set used = (result.total_cost / result.budget_limit * 100) | round(2) %}
              {{ used }}%
            </div>
          </div>

          <div class="summary-item">
            <div class="summary-item-label">PCR Improvement</div>
            <div class="summary-item-value">
              {{ "%.1f"|format(result.improvement_percent) }}%
            </div>
          </div>

          <div class="summary-item">
            <div class="summary-item-label">Roads Selected</div>
            <div class="summary-item-value">{{ result.selected|length }}/{{ roads|length }}</div>
          </div>
        </div>
      </div>

      <!-- SELECTED ROADS TABLE -->
      <div class="card">
        <h2>âœ… Jalan Terpilih untuk Diperbaiki</h2>
        {% if result.selected %}
        <table>
          <tr>
            <th>Road ID</th>
            <th>Technique</th>
            <th>Present PCR</th>
            <th>New PCR</th>
            <th>Improvement</th>
            <th>Cost (â‚¹)</th>
          </tr>
          {% for road in result.selected %}
          <tr>
            <td><strong>{{ road.id }}</strong></td>
            <td>
              <span style="background: #764ba2; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 500;">
                {{ road.technique }}
              </span>
            </td>
            <td style="text-align: center;">{{ "%.2f"|format(road.present_pcr) }}</td>
            <td style="text-align: center;">{{ "%.2f"|format(road.new_pcr) }}</td>
            <td style="text-align: center;">
              <span style="color: #22c55e; font-weight: 600;">+{{ "%.2f"|format(road.delta_pcr) }}</span>
            </td>
            <td style="text-align: right;">â‚¹{{ "{:,.0f}".format(road.cost) }}</td>
          </tr>
          {% endfor %}
          <tr style="background: #f0f7ff; font-weight: 600;">
            <td colspan="4" style="text-align: right; padding: 12px;"><strong>TOTAL:</strong></td>
            <td style="text-align: center; color: #22c55e;">+{{ "%.2f"|format(result.total_delta_pcr) }}</td>
            <td style="text-align: right;">â‚¹{{ "{:,.0f}".format(result.total_cost) }}</td>
          </tr>
        </table>
        {% else %}
        <p>Tidak ada jalan yang dipilih (mungkin budget terlalu kecil).</p>
        {% endif %}
      </div>

      <!-- ALL ROADS STATUS TABLE -->
      <div class="card">
        <h2>ğŸ“‹ Status Semua Jalan</h2>
        <table>
          <tr>
            <th>Road ID</th>
            <th>Technique</th>
            <th>Present PCR</th>
            <th>New PCR</th>
            <th>Cost (â‚¹)</th>
            <th>Status</th>
          </tr>
          {% set selected_ids = result.selected|map(attribute='id')|list %}
          {% for road in roads %}
          <tr{% if road.id in selected_ids %} style="background: #f0fff4;"{% endif %}>
            <td><strong>{{ road.id }}</strong></td>
            <td>
              <span style="background: {% if road.id in selected_ids %}#22c55e{% else %}#999{% endif %}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 500;">
                {{ road.technique }}
              </span>
            </td>
            <td style="text-align: center;">{{ "%.2f"|format(road.present_pcr) }}</td>
            <td style="text-align: center;">{{ "%.2f"|format(road.new_pcr) }}</td>
            <td style="text-align: right;">â‚¹{{ "{:,.0f}".format(road.cost) }}</td>
            <td style="text-align: center;">
              {% if road.id in selected_ids %}
                <span style="color: #22c55e; font-weight: bold;">âœ” Selected</span>
              {% else %}
                <span style="color: #ef4444; font-weight: bold;">âœ˜ Not Selected</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>

    </div>
    {% endif %}

  </form>
</div>

<script src="{{ url_for('static', filename='js/main.js', v=12) }}"></script>
</body>
</html>
